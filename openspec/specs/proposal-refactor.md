# OpenSpec Proposal: 项目重构

版本: 0.1  
日期: 2026-02-23  
作者: Codex  
状态: 提案

## 1. 背景与问题
当前代码库存在两套并行实现：
1. 顶层 `core/` + `adapters/` + `cli.py`。
2. `src/` 下的模型/解析器/适配器/存储层。

问题：
1. 重复实现导致配置分叉、功能割裂。
2. 同步链路未打通（`core/sync_manager.py` 写库为 TODO）。
3. README 与配置模板描述的能力与实际实现不一致。
4. 测试缺失，难以保证重构后的行为稳定。

## 2. 目标
1. 收敛到单一实现路径，减少重复与维护成本。
2. 打通完整数据链路：IMAP → 解析 → DB 入库。
3. 统一配置与 CLI 行为，保证文档与实现一致。
4. 增加基础测试覆盖，确保解析与存储稳定。

## 3. 非目标
1. 实现支付宝/微信/银行 CSV 导入（后续阶段）。
2. 完整报表系统或 Web UI。
3. 分布式存储或生产级任务调度。

## 4. 方案概述
1. 以 `src/` 体系为主实现：
   - 保留 `src/models/`、`src/parsers/`、`src/adapters/`、`src/storage/`。
   - `core/` 仅作为编排层，或迁移为 `src/services/`。
2. 统一配置：
   - 以 `config/config.example.yaml` 为主模板。
   - 将 `config/settings.yaml` 中未实现项标记为 future/experimental。
3. CLI 统一调用 `src` 实现：
   - `cli.py` 调用 `src.adpaters` + `src.storage`。
   - 完成入库逻辑和去重流程。
4. 建立最小测试：
   - 邮件解析器单测（CMB Email Parser）。
   - 存储层写入/去重测试。

## 5. 里程碑（建议）
1. 结构收敛（删除或迁移重复代码）。
2. 同步链路打通（入库逻辑完成）。
3. 配置与文档一致性修复。
4. 测试覆盖补齐。

## 6. 影响评估
1. 影响范围：核心模块、CLI、配置、文档。
2. 风险：重构期间接口变更、数据写入逻辑错误。
3. 缓解：分阶段合并、增加测试、保留旧路径短期兼容。

## 7. 待决问题
1. 是否保留 `core/` 作为独立层，或合并到 `src/services/`？
2. 是否保留 `adapters/` 目录下的旧实现，还是直接移除？
3. 旧配置字段是否需要兼容（如 `database` vs `data`）？
